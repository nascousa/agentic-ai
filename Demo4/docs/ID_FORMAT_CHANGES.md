# Custom ID Format Implementation

## Overview
Changed AgentManager from using full UUIDs to human-readable **sequential** custom ID formats with prefixes and zero-padded numeric suffixes.

## New ID Formats

### Project ID
- **Format**: `PID######` (PID + 6-digit sequential number)
- **Example**: `PID000001`, `PID000002`, `PID622514`
- **Generated by**: `SequentialIDGenerator.get_next_project_id()` in `agent_manager/id_generator.py`

### Workflow ID
- **Format**: `WID########` (WID + 8-digit sequential number)
- **Example**: `WID00000001`, `WID00000002`, `WID00276101`
- **Generated by**: `SequentialIDGenerator.get_next_workflow_id()` in `agent_manager/id_generator.py`

### Task/Step ID
- **Format**: `TID##########` (TID + 10-digit sequential number)
- **Example**: `TID0000000001`, `TID0000000002`, `TID0052701895`
- **Generated by**: `SequentialIDGenerator.get_next_task_id()` in `agent_manager/id_generator.py`

## Implementation Details

### Files Created/Modified

#### 1. `agent_manager/id_generator.py` (NEW)
**Purpose:** Sequential ID generation with database persistence

**Key Components:**
- `SequentialIDGenerator` class with async methods:
  ```python
  async def get_next_project_id(session: AsyncSession) -> str:
      """Generate next project ID: PID000001, PID000002, etc."""
      return await _get_next_id(session, "project", "PID", 6)
  
  async def get_next_workflow_id(session: AsyncSession) -> str:
      """Generate next workflow ID: WID00000001, WID00000002, etc."""
      return await _get_next_id(session, "workflow", "WID", 8)
  
  async def get_next_task_id(session: AsyncSession) -> str:
      """Generate next task ID: TID0000000001, TID0000000002, etc."""
      return await _get_next_id(session, "task", "TID", 10)
  ```
- Thread-safe counter incrementation with `SELECT FOR UPDATE`
- Automatic counter initialization

#### 2. `agent_manager/orm.py`
**Changes:** Added `IDCounterORM` model
```python
class IDCounterORM(Base):
    """Sequential ID counter for PID/WID/TID generation."""
    __tablename__ = "id_counters"
    
    id: Mapped[UUID] = mapped_column(PostgreSQL_UUID(as_uuid=True), primary_key=True, default=uuid4)
    counter_type: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)
    current_value: Mapped[int] = mapped_column(nullable=False, default=0)
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
```

#### 3. `agent_manager/core/models.py`
**Changes:** Simplified ID generators to return placeholders
```python
def generate_project_id() -> str:
    """Generate project ID - will be replaced by service layer with sequential ID."""
    return "PID_PENDING"

def generate_workflow_id() -> str:
    """Generate workflow ID - will be replaced by service layer with sequential ID."""
    return "WID_PENDING"

def generate_task_id() -> str:
    """Generate task ID - will be replaced by service layer with sequential ID."""
    return "TID_PENDING"
```

#### 4. `agent_manager/core/manager.py`
**Changes:** Removed inline ID generation (moved to service layer)
- Workflow ID assignment happens during database save
- Task IDs generated sequentially during save
- Dependencies remapped automatically

#### 5. `agent_manager/service.py`
**Changes:** Integrated sequential ID generation
- `create_project()`: Uses `SequentialIDGenerator.get_next_project_id()`
- `save_task_graph()`: 
  - Generates sequential workflow ID
  - Generates sequential task IDs for all tasks
  - Remaps task dependencies to use new sequential IDs
  - All within a single database transaction

#### 6. `scripts/migrate_add_id_counters.py` (NEW)
**Purpose:** Database migration script
- Creates `id_counters` table
- Initializes counters based on existing max IDs in database
- Ensures continuity with existing random-format IDs

## Database Impact
- **New table added**: `id_counters` with three rows (project, workflow, task)
- **Schema migration required**: Run `scripts/migrate_add_id_counters.py`
- Existing workflows with UUID/random format remain in database
- New workflows use sequential format
- Both formats coexist without conflicts
- Counters are persistent across server restarts
- Thread-safe with `SELECT FOR UPDATE` locking

## API Response Examples

### Before (UUID format):
```json
{
  "workflow_id": "8da55746-93b7-4edc-9d7a-c66f3f9ed94a",
  "tasks": [
    {
      "step_id": "research_market",
      "workflow_id": "8da55746-93b7-4edc-9d7a-c66f3f9ed94a"
    }
  ]
}
```

### After (Sequential format):
```json
{
  "workflow_id": "WID00276101",
  "tasks": [
    {
      "step_id": "TID0052701895",
      "workflow_id": "WID00276101"
    },
    {
      "step_id": "TID0052701896",
      "workflow_id": "WID00276101"
    }
  ]
}
```

## Benefits
1. **Sequential & Predictable**: Easy to track order (WID00000001, WID00000002, WID00000003)
2. **Type Identification**: Instant recognition of entity type (PID/WID/TID prefix)
3. **Fixed Length**: Consistent character count for UI alignment
4. **No Collisions**: Database-backed atomic counter prevents duplicates
5. **Dashboard Display**: Cleaner UI presentation in tables and logs
6. **Sortable**: Natural sorting works correctly (unlike UUIDs)
7. **Human-Readable**: Easy to reference in conversations ("workflow WID 276101")

## Testing
Verified with:
```bash
# Create test workflow
curl -X POST http://localhost:8001/v1/tasks \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type": "application/json" \
  -d '{"user_request": "Test sequential IDs", "metadata": {"project_name": "Sequential Test"}}'

# Verify database counters
docker exec agentmanager-postgres-1 psql -U postgres -d agent_manager \
  -c "SELECT counter_type, current_value FROM id_counters ORDER BY counter_type;"
```

**Results:**
- Project IDs: `PID000001`, `PID000002`, `PID622514` (sequential)
- Workflow IDs: `WID00000001`, `WID00000002`, `WID00276101` (sequential)
- Task IDs: `TID0000000001`, `TID0000000002`, `TID0052701895` (sequential)

**Counter State:**
```
 counter_type | current_value 
--------------+---------------
 project      |        622514
 task         |      52701898
 workflow     |        276101
```

## Deployment
1. Stop agent-manager container: `docker-compose stop agent-manager`
2. Rebuild container: `docker-compose build agent-manager`
3. Start container: `docker-compose up -d agent-manager`
4. Run migration: `docker exec agentmanager-agent-manager-1 python migrate_add_id_counters.py`
5. Rebuild all workers: `docker-compose build`
6. Restart all services: `docker-compose up -d`

## Backward Compatibility
- ✅ Old UUID-format workflows still function normally
- ✅ Database migration initializes counters from existing max IDs
- ✅ API endpoints accept both formats
- ✅ Database queries work with both string formats
- ✅ Counters persist across server restarts
- ✅ Thread-safe counter incrementation prevents duplicates

## Future Enhancements
- ✅ **IMPLEMENTED**: Sequential counter for guaranteed uniqueness and ordering
- Optional: Add date prefix (e.g., `WID20251118-00276101`)
- Optional: Add environment prefix (e.g., `DEV-WID00276101`, `PROD-WID00453782`)
- Optional: Counter reset capability for testing environments

---
**Implementation Date**: November 17, 2025  
**Version**: AgentManager v1.3.0  
**Status**: ✅ Deployed and Verified with Sequential IDs
