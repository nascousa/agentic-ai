graph TB
    subgraph "External Clients"
        Client1[Client Worker 1<br/>Role: Researcher]
        Client2[Client Worker 2<br/>Role: Writer]
        Client3[Client Worker 3<br/>Role: Analyst]
    end
    
    subgraph "FastAPI MCP Server"
        API[FastAPI Application]
        Endpoints[API Endpoints]
        Core[Agent Core Logic]
        
        subgraph "API Endpoints"
            Submit[POST /v1/submit_task]
            Report[POST /v1/report_result]
            Poll["GET /v1/tasks/:role/ready"]
            Health[GET /health]
        end
        
        subgraph "Core Logic"
            Manager[AgentManager]
            Worker[WorkerAgent Logic]
            Auditor[AuditorAgent Logic]
            LLM[LLMClient]
            FileLock[File Access Manager]
        end
    end
    
    subgraph "Database Layer"
        ORM[SQLAlchemy ORM]
        DB[(SQLite/PostgreSQL)]
        
        subgraph "ORM Models"
            TaskGraphORM[TaskGraphORM]
            TaskStepORM[TaskStepORM] 
            ResultORM[ResultORM]
            AuditORM[AuditReportORM]
            FileAccessORM[FileAccessORM]
        end
    end
    
    subgraph "File Coordination System"
        FileManager[File Access Manager]
        OSLocks[OS-Level Locks<br/>fcntl/msvcrt]
        DBLocks[Database Locks<br/>FileAccessORM]
        
        FileManager --> OSLocks
        FileManager --> DBLocks
    end
    
    subgraph "Workflow Execution"
        User[User/System] --> Submit
        Submit --> Manager
        Manager --> TaskGraphORM
        TaskGraphORM --> DB
        
        Client1 --> Poll
        Client2 --> Poll
        Client3 --> Poll
        Poll --> TaskStepORM
        
        Client1 --> Report
        Client2 --> Report
        Client3 --> Report
        Report --> ResultORM
        
        Manager --> Auditor
        Auditor --> AuditORM
        AuditORM --> DB
        
        Manager --> LLM
        Worker --> LLM
        Auditor --> LLM
        
        Worker --> FileLock
        FileLock --> FileManager
    end
    
    API --> Endpoints
    Endpoints --> Core
    Core --> ORM
    ORM --> DB
    
    classDef client fill:transparent,stroke:#01579b,stroke-width:2px
    classDef server fill:transparent,stroke:#01579b,stroke-width:2px
    classDef database fill:transparent,stroke:#2e7d32,stroke-width:2px
    classDef api fill:transparent,stroke:#e65100,stroke-width:2px
    classDef logic fill:transparent,stroke:#4a148c,stroke-width:2px
    classDef fileSystem fill:transparent,stroke:#f57f17,stroke-width:2px
    
    class Client1,Client2,Client3 client
    class API,Endpoints,Core server
    class DB,ORM,TaskGraphORM,TaskStepORM,ResultORM,AuditORM,FileAccessORM database
    class Submit,Report,Poll,Health api
    class Manager,Worker,Auditor,LLM,FileLock logic
    class FileManager,OSLocks,DBLocks fileSystem
