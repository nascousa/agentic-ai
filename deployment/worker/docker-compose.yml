# =============================================================================
# AgentManager Worker Client - Docker Compose Deployment
# =============================================================================
version: '3.8'

services:
  # Research Worker
  worker-researcher:
    build:
      context: ../../
      dockerfile: deployment/worker/Dockerfile
    container_name: am-worker-researcher
    environment:
      - WORKER_CLIENT_ID=researcher-${HOSTNAME:-local}-001
      - AM_SERVER_URL=${AM_SERVER_URL:-http://host.docker.internal:8000}
      - AM_AUTH_TOKEN=${AM_AUTH_TOKEN}
      - AGENT_ROLES=researcher
      - POLLING_INTERVAL=3
      - MAX_PARALLEL_TASKS=2
      - LOG_LEVEL=INFO
      - ENABLE_METRICS=true
      - METRICS_PORT=8080
    volumes:
      - ./config/researcher_config.json:/app/config/worker_config.json:ro
      - ./logs:/app/logs
      - ./temp:/app/temp
    ports:
      - "8081:8080"  # Health check and metrics
    restart: unless-stopped
    networks:
      - agentmanager
    depends_on:
      - config-generator

  # Analyst Worker
  worker-analyst:
    build:
      context: ../../
      dockerfile: deployment/worker/Dockerfile
    container_name: am-worker-analyst
    environment:
      - WORKER_CLIENT_ID=analyst-${HOSTNAME:-local}-001
      - AM_SERVER_URL=${AM_SERVER_URL:-http://host.docker.internal:8000}
      - AM_AUTH_TOKEN=${AM_AUTH_TOKEN}
      - AGENT_ROLES=analyst
      - POLLING_INTERVAL=3
      - MAX_PARALLEL_TASKS=1
      - LOG_LEVEL=INFO
    volumes:
      - ./config/analyst_config.json:/app/config/worker_config.json:ro
      - ./logs:/app/logs
      - ./temp:/app/temp
    ports:
      - "8082:8080"
    restart: unless-stopped
    networks:
      - agentmanager
    depends_on:
      - config-generator

  # Writer Worker
  worker-writer:
    build:
      context: ../../
      dockerfile: deployment/worker/Dockerfile
    container_name: am-worker-writer
    environment:
      - WORKER_CLIENT_ID=writer-${HOSTNAME:-local}-001
      - AM_SERVER_URL=${AM_SERVER_URL:-http://host.docker.internal:8000}
      - AM_AUTH_TOKEN=${AM_AUTH_TOKEN}
      - AGENT_ROLES=writer
      - POLLING_INTERVAL=5
      - MAX_PARALLEL_TASKS=1
      - LOG_LEVEL=INFO
    volumes:
      - ./config/writer_config.json:/app/config/worker_config.json:ro
      - ./logs:/app/logs
      - ./temp:/app/temp
    ports:
      - "8083:8080"
    restart: unless-stopped
    networks:
      - agentmanager
    depends_on:
      - config-generator

  # Multi-role Worker (for smaller deployments)
  worker-multi:
    build:
      context: ../../
      dockerfile: deployment/worker/Dockerfile
    container_name: am-worker-multi
    environment:
      - WORKER_CLIENT_ID=multi-${HOSTNAME:-local}-001
      - AM_SERVER_URL=${AM_SERVER_URL:-http://host.docker.internal:8000}
      - AM_AUTH_TOKEN=${AM_AUTH_TOKEN}
      - AGENT_ROLES=researcher,analyst,writer,reviewer
      - POLLING_INTERVAL=4
      - MAX_PARALLEL_TASKS=3
      - LOG_LEVEL=INFO
    volumes:
      - ./config/multi_config.json:/app/config/worker_config.json:ro
      - ./logs:/app/logs
      - ./temp:/app/temp
    ports:
      - "8084:8080"
    restart: unless-stopped
    networks:
      - agentmanager
    depends_on:
      - config-generator
    profiles:
      - multi-worker

  # Configuration Generator (runs once to create config files)
  config-generator:
    image: alpine:latest
    container_name: am-config-generator
    volumes:
      - ./worker_config.template.json:/template.json:ro
      - ./config:/output
    environment:
      - AM_SERVER_URL=${AM_SERVER_URL:-http://host.docker.internal:8000}
      - AM_AUTH_TOKEN=${AM_AUTH_TOKEN}
    command: |
      sh -c "
        apk add --no-cache envsubst gettext
        
        # Generate researcher config
        export AGENT_ROLES=researcher POLLING_INTERVAL=3 MAX_PARALLEL_TASKS=2 WORKER_CLIENT_ID=researcher-$$HOSTNAME-001
        envsubst < /template.json > /output/researcher_config.json
        
        # Generate analyst config  
        export AGENT_ROLES=analyst POLLING_INTERVAL=3 MAX_PARALLEL_TASKS=1 WORKER_CLIENT_ID=analyst-$$HOSTNAME-001
        envsubst < /template.json > /output/analyst_config.json
        
        # Generate writer config
        export AGENT_ROLES=writer POLLING_INTERVAL=5 MAX_PARALLEL_TASKS=1 WORKER_CLIENT_ID=writer-$$HOSTNAME-001
        envsubst < /template.json > /output/writer_config.json
        
        # Generate multi config
        export AGENT_ROLES='researcher,analyst,writer,reviewer' POLLING_INTERVAL=4 MAX_PARALLEL_TASKS=3 WORKER_CLIENT_ID=multi-$$HOSTNAME-001
        envsubst < /template.json > /output/multi_config.json
        
        echo 'Configuration files generated successfully'
      "
    networks:
      - agentmanager

networks:
  agentmanager:
    driver: bridge
    name: agentmanager-network

volumes:
  worker-logs:
    driver: local
  worker-temp:
    driver: local